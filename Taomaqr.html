<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC QR Service | Dynamic System</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f8f9fa; }
        .hidden { display: none !important; }
        
        /* Loading Overlay */
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column;
            justify-content: center; align-items: center;
        }
        
        /* Error Box */
        #error-console {
            display: none;
            position: fixed; bottom: 0; left: 0; width: 100%;
            background: #343a40; color: #ff6b6b;
            padding: 20px; font-family: monospace; font-size: 12px;
            max-height: 200px; overflow-y: auto; z-index: 10000;
        }

        /* Container Styles */
        .main-container { max-width: 600px; margin: 50px auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .btn-google { background: white; border: 1px solid #ddd; width: 100%; padding: 10px; display: flex; justify-content: center; align-items: center; gap: 10px; }
        .btn-google:hover { background: #f1f1f1; }
        
        /* QR Result */
        #qrcode img { margin: 0 auto; border: 5px solid #fff; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <h5 id="loading-text">Đang kết nối hệ thống VDC...</h5>
        <div id="setup-warning" class="hidden text-danger mt-3 text-center px-3" style="max-width: 500px;">
            <i class="fas fa-exclamation-triangle fa-2x mb-2"></i><br>
            <strong>LỖI CÀI ĐẶT PHÁT HIỆN:</strong><br>
            <span id="warning-msg"></span>
        </div>
    </div>

    <div id="error-console"></div>

    <div id="auth-view" class="main-container hidden text-center">
        <h3 class="text-primary fw-bold mb-4">VDC QR Service</h3>
        <button class="btn-google" id="btn-login">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
            Đăng nhập với Google
        </button>
    </div>

    <div id="creator-view" class="main-container hidden">
        <div class="d-flex justify-content-between mb-4">
            <span>Xin chào, <b id="user-name">User</b></span>
            <button class="btn btn-sm btn-outline-danger" id="btn-logout">Thoát</button>
        </div>

        <div class="mb-3">
            <label>Tiêu đề</label><input type="text" id="inp-title" class="form-control">
        </div>
        <div class="mb-3">
            <label>Link gốc</label><input type="url" id="inp-link" class="form-control" placeholder="https://...">
        </div>
        
        <button class="btn btn-primary w-100" onclick="createQR()">Tạo QR</button>

        <div id="result-area" class="hidden text-center mt-4">
            <div id="qrcode"></div>
            <p class="mt-2 text-success small">Đã tạo mã Dynamic!</p>
        </div>
    </div>

    <div id="viewer-view" class="main-container hidden text-center">
        <h2 id="view-title" class="fw-bold"></h2>
        <p id="view-desc" class="text-muted"></p>
        <a id="view-btn" href="#" class="btn btn-success btn-lg mt-3" target="_blank">Mở Tài Liệu</a>
    </div>

    <script>
        // Hàm hiển thị lỗi ra màn hình
        function showError(msg) {
            const warningBox = document.getElementById('setup-warning');
            const warningMsg = document.getElementById('warning-msg');
            const spinner = document.querySelector('.spinner-border');
            
            spinner.classList.add('hidden'); // Ẩn xoay vòng
            warningBox.classList.remove('hidden'); // Hiện bảng lỗi
            warningMsg.innerHTML = msg;
            
            // Hiện log chi tiết bên dưới
            const consoleBox = document.getElementById('error-console');
            consoleBox.style.display = 'block';
            consoleBox.innerHTML += `<div>> ${msg}</div>`;
        }

        // 1. Kiểm tra giao thức file://
        if (window.location.protocol === 'file:') {
            showError(`
                Bạn đang mở file trực tiếp (file://).<br>
                Google Firebase <strong>KHÔNG</strong> chạy được theo cách này.<br><br>
                <strong>Cách khắc phục:</strong><br>
                1. Cài đặt "Live Server" trong VS Code.<br>
                2. Hoặc mở Terminal gõ: <code>python -m http.server</code><br>
                3. Truy cập qua <code>http://localhost:8000</code>
            `);
            throw new Error("File protocol detected"); // Dừng chạy script tiếp theo
        }

        // 2. Timeout an toàn: Nếu sau 8 giây mà chưa tải xong -> Báo lỗi mạng
        setTimeout(() => {
            const overlay = document.getElementById('loading-overlay');
            if (!overlay.classList.contains('hidden') && document.getElementById('setup-warning').classList.contains('hidden')) {
                showError("Kết nối quá lâu. Có thể do lỗi mạng hoặc cấu hình Firebase sai.");
            }
        }, 8000);

        // 3. Bắt lỗi toàn cục
        window.onerror = function(message, source, lineno, colno, error) {
            showError(`Lỗi Script: ${message}`);
        };
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, addDoc, collection } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", 
            authDomain: "tavietnam-78ae8.firebaseapp.com", 
            projectId: "tavietnam-78ae8", 
            storageBucket: "tavietnam-78ae8.firebasestorage.app", 
            messagingSenderId: "670121705534", 
            appId: "1:670121705534:web:1027ad98550573ad37116f" 
        };

        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            const db = getFirestore(app);
            const provider = new GoogleAuthProvider();

            // Routing đơn giản
            const params = new URLSearchParams(window.location.search);
            const qrId = params.get('id');

            if (qrId) {
                // --- VIEW MODE ---
                loadQRCode(qrId);
            } else {
                // --- CREATOR MODE ---
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        showScreen('creator-view');
                        document.getElementById('user-name').innerText = user.displayName;
                        window.currentUser = user;
                    } else {
                        showScreen('auth-view');
                    }
                    hideLoading();
                });
            }

            // Functions
            window.createQR = async () => {
                const title = document.getElementById('inp-title').value;
                const link = document.getElementById('inp-link').value;
                if(!link) return alert("Chưa nhập link!");

                const docRef = await addDoc(collection(db, "qr_codes"), {
                    title, link, createdAt: new Date().toISOString()
                });

                const shortUrl = `${window.location.origin}${window.location.pathname}?id=${docRef.id}`;
                
                document.getElementById('result-area').classList.remove('hidden');
                document.getElementById('qrcode').innerHTML = "";
                new QRCode(document.getElementById('qrcode'), { text: shortUrl, width: 150, height: 150 });
            }

            document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
            document.getElementById('btn-logout').onclick = () => signOut(auth).then(()=>location.reload());

            async function loadQRCode(id) {
                const snap = await getDoc(doc(db, "qr_codes", id));
                if (snap.exists()) {
                    const data = snap.data();
                    showScreen('viewer-view');
                    document.getElementById('view-title').innerText = data.title || "Tài liệu";
                    document.getElementById('view-btn').href = data.link;
                    hideLoading();
                } else {
                    alert("QR không tồn tại");
                    hideLoading();
                }
            }

        } catch (e) {
            showError("Firebase Error: " + e.message);
        }

        function showScreen(id) {
            ['auth-view', 'creator-view', 'viewer-view'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }
    </script>
</body>
</html>
