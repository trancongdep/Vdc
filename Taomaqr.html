<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC Smart QR | Quản lý & Kết nối</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #4e54c8;
            --secondary: #8f94fb;
            --accent: #ff6b6b;
            --glass: rgba(255, 255, 255, 0.95);
        }
        
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .hidden { display: none !important; }

        /* --- NAVBAR & SIDEBAR STYLES --- */
        .top-navbar {
            background: white;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .offcanvas {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(10px);
        }

        .user-panel {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .menu-link {
            padding: 15px 25px;
            display: block;
            color: #555;
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            border-left: 4px solid transparent;
        }
        .menu-link:hover, .menu-link.active {
            background: #f8f9fa;
            color: var(--primary);
            border-left: 4px solid var(--primary);
        }
        .menu-link i { width: 30px; text-align: center; }

        /* --- MAIN CONTENT --- */
        .main-content {
            flex: 1; /* Đẩy footer xuống dưới */
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .content-card {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.05);
            min-height: 400px;
        }

        /* --- FOOTER --- */
        .app-footer {
            background: #343a40;
            color: #adb5bd;
            text-align: center;
            padding: 20px;
            margin-top: auto;
            font-size: 0.9rem;
        }

        /* --- VIEWER STYLES --- */
        .viewer-header {
            background: linear-gradient(to right, var(--primary), var(--secondary));
            color: white;
            padding: 40px 20px 60px;
            text-align: center;
            border-radius: 0 0 50% 50% / 20px;
        }
        .viewer-card {
            margin-top: -40px;
            width: 90%;
            margin-left: auto;
            margin-right: auto;
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 600px;
        }

        /* --- COMMON COMPONENTS --- */
        .qr-item {
            border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 15px; background: white;
        }
        .msg-item {
            border-left: 3px solid var(--accent); background: #fff5f5; padding: 10px 15px; margin-bottom: 10px; border-radius: 4px;
        }
        #loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
        }
        
        .version-tag { position: fixed; bottom: 5px; right: 5px; font-size: 10px; color: #555; opacity: 0.5; }
    </style>
</head>
<body>

    <div id="loading-overlay">
        <div class="spinner-border text-primary mb-3" role="status"></div>
        <div class="text-muted small">Đang tải hệ thống...</div>
    </div>

    <div id="auth-view" class="container hidden d-flex align-items-center justify-content-center" style="min-height: 80vh;">
        <div class="card border-0 shadow-lg rounded-4 p-5 text-center" style="max-width: 400px;">
            <h3 class="fw-bold text-primary mb-2">VDC Smart QR</h3>
            <p class="text-muted mb-4">Đăng nhập để quản lý hệ thống</p>
            <button class="btn btn-outline-dark w-100 py-2 gap-2 d-flex justify-content-center" id="btn-login">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" width="20">
                <span>Google Login</span>
            </button>
        </div>
    </div>

    <div id="profile-view" class="container hidden mt-5">
        <div class="card border-0 shadow p-4 mx-auto" style="max-width: 500px;">
            <h4 class="text-center mb-4">Hoàn tất hồ sơ</h4>
            <form id="profile-form">
                <div class="mb-3"><label>Tên hiển thị</label><input type="text" id="profile-name" class="form-control" required></div>
                <div class="mb-3"><label>Số điện thoại</label><input type="tel" id="profile-phone" class="form-control" required></div>
                <button type="submit" class="btn btn-primary w-100">Lưu thông tin</button>
            </form>
        </div>
    </div>

    <div id="dashboard-view" class="hidden d-flex flex-column w-100 h-100">
        
        <div class="top-navbar">
            <div class="d-flex align-items-center">
                <button class="btn btn-light me-3" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                    <i class="fas fa-bars fa-lg"></i>
                </button>
                <h5 class="mb-0 fw-bold text-primary">VDC Admin</h5>
            </div>
            <div>
                <span class="badge bg-light text-dark border">Quota: <span id="quota-display">0/5</span></span>
            </div>
        </div>

        <div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
            <div class="offcanvas-header p-0">
                <div class="user-panel w-100">
                    <i class="fas fa-user-circle fa-3x mb-2"></i>
                    <h5 class="mb-0" id="user-display-name">User</h5>
                    <small class="opacity-75" id="user-display-email">email@example.com</small>
                </div>
            </div>
            <div class="offcanvas-body p-0 pt-2">
                <nav>
                    <a href="#" class="menu-link active" onclick="switchTab('create')">
                        <i class="fas fa-plus-circle"></i> Tạo mã mới
                    </a>
                    <a href="#" class="menu-link" onclick="switchTab('list')">
                        <i class="fas fa-list-ul"></i> Quản lý mã QR
                    </a>
                    <a href="#" class="menu-link d-flex justify-content-between align-items-center" onclick="switchTab('inbox')">
                        <span><i class="fas fa-inbox"></i> Hộp thư</span>
                        <span class="badge bg-danger rounded-pill hidden" id="msg-badge">0</span>
                    </a>
                    <hr>
                    <a href="#" class="menu-link text-danger" id="btn-logout">
                        <i class="fas fa-sign-out-alt"></i> Đăng xuất
                    </a>
                </nav>
            </div>
        </div>

        <div class="main-content">
            <div class="content-card">
                
                <div id="tab-create" class="tab-pane">
                    <h4 class="mb-4 text-primary"><i class="fas fa-magic"></i> Tạo mã QR Động</h4>
                    <div class="mb-3">
                        <label class="form-label text-muted small">TIÊU ĐỀ TÀI LIỆU</label>
                        <input type="text" id="inp-title" class="form-control" placeholder="Ví dụ: Tài liệu hướng dẫn...">
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">MÔ TẢ NGẮN</label>
                        <textarea id="inp-desc" class="form-control" rows="3" placeholder="Nhập ghi chú..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label class="form-label text-muted small">LINK ĐÍCH (DRIVE/WEB)</label>
                        <input type="url" id="inp-link" class="form-control" placeholder="https://...">
                    </div>
                    <button class="btn btn-primary w-100 py-2" onclick="createQR()">Tạo Mã Ngay</button>

                    <div id="new-qr-result" class="mt-4 p-4 bg-light rounded text-center hidden border border-success">
                        <h5 class="text-success">Thành công!</h5>
                        <div id="qrcode-container" class="my-3 d-flex justify-content-center"></div>
                        <button class="btn btn-sm btn-dark" onclick="downloadNewQR()"><i class="fas fa-download"></i> Tải ảnh về</button>
                    </div>
                </div>

                <div id="tab-list" class="tab-pane hidden">
                    <h4 class="mb-4 text-primary"><i class="fas fa-tasks"></i> Danh sách mã đã tạo</h4>
                    <div id="my-qr-list" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>

                <div id="tab-inbox" class="tab-pane hidden">
                    <h4 class="mb-4 text-primary"><i class="fas fa-envelope-open-text"></i> Hộp thư khách hàng</h4>
                    <div id="inbox-list" style="max-height: 60vh; overflow-y: auto;"></div>
                </div>
            </div>
        </div>
    </div>

    <div id="viewer-view" class="hidden">
        <div class="viewer-header">
            <h2 class="fw-bold"><i class="fas fa-cloud"></i> VDC ONLINE</h2>
            <p class="mb-0">Cổng thông tin tài liệu số</p>
        </div>
        <div class="viewer-card">
            <span class="badge bg-primary bg-opacity-10 text-primary mb-3 px-3 py-2 rounded-pill">
                <i class="fas fa-user-edit"></i> <span id="view-owner">...</span>
            </span>
            <h3 id="view-title" class="fw-bold text-dark mb-3">...</h3>
            <div class="text-start bg-light p-3 rounded mb-4 border">
                <p id="view-desc" class="mb-0 text-secondary" style="white-space: pre-line;">...</p>
            </div>
            <div class="d-grid gap-2">
                <a id="view-btn" href="#" class="btn btn-success btn-lg shadow-sm" target="_blank">
                    <i class="fas fa-external-link-alt"></i> Truy cập Tài Liệu
                </a>
                <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#contactModal">
                    <i class="fas fa-comment"></i> Nhắn tin cho tác giả
                </button>
            </div>
        </div>
    </div>

    <footer class="app-footer hidden" id="main-footer">
        <div class="container">
            <p class="mb-1 fw-bold">VDC Smart QR Solution</p>
            <p class="mb-0 small">Copyright &copy; 2026 Vietnam Data Center. All rights reserved.</p>
            <div class="mt-2">
                <a href="#" class="text-secondary text-decoration-none me-2">Privacy</a>
                <a href="#" class="text-secondary text-decoration-none">Terms</a>
            </div>
        </div>
    </footer>

    <div class="modal fade" id="contactModal" tabindex="-1"><div class="modal-dialog modal-dialog-centered"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Gửi tin nhắn</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="text" id="msg-sender" class="form-control mb-2" placeholder="Tên của bạn"><textarea id="msg-content" class="form-control" rows="3" placeholder="Nội dung..."></textarea></div><div class="modal-footer"><button class="btn btn-primary w-100" onclick="sendContactMessage()">Gửi</button></div></div></div></div>
    <div class="modal fade" id="editModal" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header"><h5 class="modal-title">Sửa nội dung</h5><button class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body"><input type="hidden" id="edit-id"><input type="text" id="edit-title" class="form-control mb-2"><textarea id="edit-desc" class="form-control mb-2"></textarea><input type="url" id="edit-link" class="form-control"></div><div class="modal-footer"><button class="btn btn-primary" onclick="saveEdit()">Lưu</button></div></div></div></div>

    <div class="version-tag">v2.1 UI Update</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, deleteDoc, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Config
        const firebaseConfig = { apiKey: "AIzaSyCzWjfcD5Dgq7V-i2izb9tKLR6QM6qWPQo", authDomain: "tavietnam-78ae8.firebaseapp.com", projectId: "tavietnam-78ae8", storageBucket: "tavietnam-78ae8.firebasestorage.app", messagingSenderId: "670121705534", appId: "1:670121705534:web:1027ad98550573ad37116f" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        let currentUser, userData, currentQrOwnerId;

        document.addEventListener('DOMContentLoaded', async () => {
            const qrId = new URLSearchParams(window.location.search).get('id');
            if (qrId) {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('main-footer').classList.remove('hidden'); // Show footer on viewer
                loadQrContent(qrId);
            } else {
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        currentUser = user;
                        await syncUser(user);
                    } else {
                        document.getElementById('loading-overlay').classList.add('hidden');
                        showView('auth-view');
                    }
                });
            }
        });

        // --- Core Logic ---
        async function syncUser(user) {
            const ref = doc(db, "users", user.uid);
            const snap = await getDoc(ref);
            if (snap.exists()) {
                userData = snap.data();
                if (!userData.phone) showView('profile-view');
                else {
                    if (userData.lastDate !== new Date().toDateString()) await updateDoc(ref, { lastDate: new Date().toDateString(), dailyCount: 0 });
                    loadDashboard();
                }
            } else showView('profile-view');
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        document.getElementById('profile-form').onsubmit = async (e) => {
            e.preventDefault();
            const newUser = { uid: currentUser.uid, email: currentUser.email, displayName: document.getElementById('profile-name').value, phone: document.getElementById('profile-phone').value, dailyLimit: 5, dailyCount: 0, lastDate: new Date().toDateString(), createdAt: new Date().toISOString() };
            await setDoc(doc(db, "users", currentUser.uid), newUser);
            userData = newUser;
            loadDashboard();
        };

        function loadDashboard() {
            showView('dashboard-view');
            document.getElementById('main-footer').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = userData.displayName;
            document.getElementById('user-display-email').innerText = userData.email;
            document.getElementById('quota-display').innerText = `${userData.dailyCount||0}/${userData.dailyLimit}`;
            loadMyQRs();
            loadInbox();
        }

        // --- Tabs & Sidebar ---
        window.switchTab = (tab) => {
            ['create', 'list', 'inbox'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${tab}`).classList.remove('hidden');
            
            // Auto hide sidebar on mobile
            const sidebar = bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu'));
            if(sidebar) sidebar.hide();

            // Update Active State
            document.querySelectorAll('.menu-link').forEach(l => l.classList.remove('active'));
            event.currentTarget.classList.add('active');

            if(tab === 'list') loadMyQRs();
            if(tab === 'inbox') loadInbox();
        };

        // --- QR Logic ---
        window.createQR = async () => {
            if ((userData.dailyCount || 0) >= userData.dailyLimit) return alert("Hết lượt tạo hôm nay!");
            const title = document.getElementById('inp-title').value;
            const link = document.getElementById('inp-link').value;
            if (!link) return alert("Thiếu Link!");
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            const docRef = await addDoc(collection(db, "qr_codes"), { title, desc: document.getElementById('inp-desc').value, link, createdBy: currentUser.uid, ownerName: userData.displayName, createdAt: new Date().toISOString() });
            
            await updateDoc(doc(db, "users", currentUser.uid), { dailyCount: (userData.dailyCount||0) + 1 });
            userData.dailyCount++;
            document.getElementById('quota-display').innerText = `${userData.dailyCount}/${userData.dailyLimit}`;
            
            const url = `${window.location.origin}${window.location.pathname}?id=${docRef.id}`;
            document.getElementById('qrcode-container').innerHTML = "";
            new QRCode(document.getElementById('qrcode-container'), { text: url, width: 150, height: 150 });
            document.getElementById('new-qr-result').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('hidden');
            
            document.getElementById('inp-title').value = ""; document.getElementById('inp-link').value = "";
        };

        async function loadMyQRs() {
            const list = document.getElementById('my-qr-list');
            list.innerHTML = "Đang tải...";
            const q = query(collection(db, "qr_codes"), where("createdBy", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            list.innerHTML = snap.empty ? "<p class='text-muted text-center'>Chưa có mã nào</p>" : "";
            snap.forEach(d => {
                const qr = d.data();
                list.innerHTML += `<div class="qr-item d-flex justify-content-between align-items-center"><div><strong>${qr.title}</strong><br><small class="text-muted">${qr.link}</small></div><div><button class="btn btn-sm btn-outline-primary me-1" onclick="openEdit('${d.id}')"><i class="fas fa-edit"></i></button><button class="btn btn-sm btn-outline-danger" onclick="deleteQR('${d.id}')"><i class="fas fa-trash"></i></button></div></div>`;
            });
        }

        window.openEdit = async (id) => {
            const d = (await getDoc(doc(db, "qr_codes", id))).data();
            document.getElementById('edit-id').value = id; document.getElementById('edit-title').value = d.title; document.getElementById('edit-desc').value = d.desc; document.getElementById('edit-link').value = d.link;
            new bootstrap.Modal(document.getElementById('editModal')).show();
        };

        window.saveEdit = async () => {
            await updateDoc(doc(db, "qr_codes", document.getElementById('edit-id').value), { title: document.getElementById('edit-title').value, desc: document.getElementById('edit-desc').value, link: document.getElementById('edit-link').value });
            alert("Đã lưu!"); location.reload();
        };

        window.deleteQR = async (id) => {
            if(confirm("Xóa mã này?")) { await deleteDoc(doc(db, "qr_codes", id)); loadMyQRs(); }
        };

        // --- Inbox & Contact ---
        async function loadInbox() {
            const list = document.getElementById('inbox-list');
            list.innerHTML = "Đang tải...";
            const q = query(collection(db, "messages"), where("toUid", "==", currentUser.uid), orderBy("createdAt", "desc"));
            const snap = await getDocs(q);
            list.innerHTML = snap.empty ? "<p class='text-muted text-center'>Trống</p>" : "";
            let unread = 0;
            snap.forEach(d => {
                const m = d.data();
                list.innerHTML += `<div class="msg-item"><strong>${m.senderName}</strong> <small class="text-muted float-end">${new Date(m.createdAt).toLocaleDateString()}</small><p class="mb-0 mt-1">${m.content}</p><small class="text-primary">QR: ${m.qrTitle}</small></div>`;
                unread++;
            });
            if(unread>0) { document.getElementById('msg-badge').innerText = unread; document.getElementById('msg-badge').classList.remove('hidden'); }
        }

        async function loadQrContent(id) {
            try {
                const d = (await getDoc(doc(db, "qr_codes", id))).data();
                showView('viewer-view');
                document.getElementById('view-title').innerText = d.title; document.getElementById('view-desc').innerText = d.desc; document.getElementById('view-owner').innerText = d.ownerName; document.getElementById('view-btn').href = d.link;
                currentQrOwnerId = d.createdBy; window.currentQrTitle = d.title;
            } catch(e) { document.body.innerHTML = "<h3 class='text-center mt-5'>Mã không tồn tại</h3>"; }
        }

        window.sendContactMessage = async () => {
            await addDoc(collection(db, "messages"), { toUid: currentQrOwnerId, senderName: document.getElementById('msg-sender').value || "Ẩn danh", content: document.getElementById('msg-content').value, qrTitle: window.currentQrTitle, createdAt: new Date().toISOString() });
            alert("Đã gửi!"); bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide();
        };

        // --- Utils ---
        document.getElementById('btn-login').onclick = () => signInWithPopup(auth, provider);
        document.getElementById('btn-logout').onclick = () => signOut(auth).then(()=>location.reload());
        window.downloadNewQR = () => { const a = document.createElement('a'); a.download = 'QR.png'; a.href = document.querySelector('#qrcode-container img').src; a.click(); };

        function showView(id) {
            ['auth-view', 'profile-view', 'dashboard-view', 'viewer-view'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }
    </script>
</body>
</html>
