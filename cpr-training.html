<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VDC - WebAR CPR</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module" src="https://ajax.googleapis.com/ajax/libs/model-viewer/3.3.0/model-viewer.min.js"></script>
    <style>
        model-viewer { width: 100vw; height: 100vh; background-color: black; }
        
        /* Nút bấm trong suốt phủ lên ngực nạn nhân */
        .hotspot-chest {
            width: 80px; height: 80px;
            background: rgba(255, 0, 0, 0.2);
            border: 2px dashed red;
            border-radius: 50%;
            cursor: pointer;
            transform: translateY(-50%); /* Căn chỉnh vị trí */
        }
        .hotspot-chest:active { background: rgba(255, 0, 0, 0.5); }

        /* Giao diện HUD (Head-up Display) nổi trên Camera */
        #ar-hud {
            position: fixed; bottom: 40px; left: 0; right: 0;
            text-align: center; pointer-events: none;
        }
    </style>
</head>
<body>

    <model-viewer 
        id="cpr-model"
        src="https://modelviewer.dev/shared-assets/models/RobotExpressive.glb" 
        ar ar-modes="webxr scene-viewer quick-look" 
        camera-controls 
        shadow-intensity="1"
        disable-tap> <button class="hotspot-chest" slot="hotspot-chest" 
                data-position="0 1.2 0.2" 
                data-normal="0 0 1"
                onclick="performCompression()">
        </button>

    </model-viewer>

    <div id="ar-hud">
        <div class="inline-block bg-black/70 backdrop-blur-md text-white px-6 py-4 rounded-2xl border border-white/20">
            <div class="text-xs text-gray-300 uppercase tracking-wider mb-1">Nhịp tim (BPM)</div>
            <div class="flex items-end justify-center gap-2">
                <span id="bpm-val" class="text-5xl font-bold text-gray-200">0</span>
                <span id="feedback" class="text-sm font-bold mb-2 px-2 py-1 rounded bg-gray-600">Sẵn sàng</span>
            </div>
            <div class="w-48 h-2 bg-gray-600 rounded-full mt-3 overflow-hidden">
                <div id="bpm-bar" class="h-full bg-green-500 w-0 transition-all duration-200"></div>
            </div>
            <p class="text-[10px] mt-2 text-gray-400">Ấn vào vòng tròn đỏ trên ngực để ép tim</p>
        </div>
    </div>

    <script>
        const modelViewer = document.querySelector("#cpr-model");
        const bpmDisplay = document.getElementById("bpm-val");
        const feedbackBadge = document.getElementById("feedback");
        const bpmBar = document.getElementById("bpm-bar");
        
        let lastPress = 0;

        function performCompression() {
            const now = Date.now();
            
            // 1. Chạy Animation ép tim (Giả lập bằng 'Dance' hoặc 'Jump')
            // Với file 3D chuẩn VDC, bạn đổi thành: modelViewer.animationName = 'Chest_Compression';
            modelViewer.animationName = 'Jump'; 
            modelViewer.play();
            setTimeout(() => modelViewer.pause(), 300); // Nhún xong dừng lại ngay

            // 2. Tính toán nhịp
            if (lastPress !== 0) {
                const diff = now - lastPress;
                const bpm = Math.round(60000 / diff);

                bpmDisplay.innerText = bpm;
                
                // Hiển thị thanh bar
                let percent = (bpm / 150) * 100;
                bpmBar.style.width = Math.min(percent, 100) + "%";

                // Đánh giá
                if (bpm < 100) {
                    feedbackBadge.innerText = "NHANH HƠN!";
                    feedbackBadge.className = "text-sm font-bold mb-2 px-2 py-1 rounded bg-yellow-500 text-black";
                    bpmBar.className = "h-full w-0 transition-all duration-200 bg-yellow-500";
                } else if (bpm > 120) {
                    feedbackBadge.innerText = "CHẬM LẠI!";
                    feedbackBadge.className = "text-sm font-bold mb-2 px-2 py-1 rounded bg-red-500 text-white";
                    bpmBar.className = "h-full w-0 transition-all duration-200 bg-red-500";
                } else {
                    feedbackBadge.innerText = "TỐT!";
                    feedbackBadge.className = "text-sm font-bold mb-2 px-2 py-1 rounded bg-green-500 text-white";
                    bpmBar.className = "h-full w-0 transition-all duration-200 bg-green-500";
                }
            }
            lastPress = now;
        }
    </script>
</body>
</html>
