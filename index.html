<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VDC COMMANDER PRO v24.10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        .page-content { display: none; height: calc(100vh - 70px); }
        .page-content.active { display: flex; flex-direction: column; }
        #sidebar { transition: transform 0.3s ease; z-index: 100; }
        .sidebar-closed { transform: translateX(-100%); }
        .company-name-cell { white-space: normal !important; word-break: break-word !important; min-width: 200px; line-height: 1.4; cursor: pointer; }
        #log-container { display: flex; flex-direction: column-reverse; }
    </style>
</head>
<body class="bg-gray-950 text-gray-200 min-h-screen overflow-hidden font-sans text-sm">

    <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/80 z-[90] hidden"></div>

    <aside id="sidebar" class="fixed left-0 top-0 h-full w-80 bg-gray-900 border-r border-gray-800 sidebar-closed flex flex-col shadow-2xl z-[100]">
        <div class="p-6 flex justify-between items-center border-b border-gray-800">
            <h2 class="text-blue-500 font-bold uppercase text-xs italic">VDC COMMANDER v24.10</h2>
            <button onclick="toggleSidebar()" class="text-gray-500"><i class="fa-solid fa-xmark text-xl"></i></button>
        </div>
        <div class="flex-1 p-4 space-y-4 overflow-y-auto">
            <div class="grid grid-cols-2 gap-2">
                <button onclick="switchPage('stats')" class="flex flex-col items-center gap-2 p-3 rounded-xl bg-blue-900/20 text-blue-400 border border-blue-500/30 font-bold"><i class="fa-solid fa-chart-pie"></i><span class="text-[10px]">GIÁM SÁT</span></button>
                <button onclick="switchPage('leads')" class="flex flex-col items-center gap-2 p-3 rounded-xl text-gray-400 hover:bg-gray-800 border border-transparent"><i class="fa-solid fa-address-book"></i><span class="text-[10px]">DỮ LIỆU</span></button>
            </div>
            <hr class="border-gray-800">
            <select id="target_job" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-xs text-white"><option value="Tất cả các ngành">-- TẤT CẢ NGÀNH --</option><option value="Công ty may mặc">May mặc</option><option value="Công ty cơ khí">Cơ khí</option></select>
            <select id="target_loc" class="w-full bg-gray-800 border border-gray-700 rounded-lg p-3 text-xs text-white"></select>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button onclick="setMode('SCOUT')" id="mode-SCOUT" class="py-2 rounded font-bold text-[10px]">SCOUT</button>
                <button onclick="setMode('REFRESH')" id="mode-REFRESH" class="py-2 rounded font-bold text-[10px]">REFRESH</button>
            </div>
            <button onclick="saveTargetConfig()" class="w-full bg-blue-600 py-4 rounded-xl font-bold uppercase text-xs mt-4">Kích hoạt</button>
        </div>
    </aside>

    <main class="h-screen flex flex-col">
        <nav class="h-[70px] bg-gray-900 border-b border-gray-800 p-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <button onclick="toggleSidebar()" class="w-10 h-10 bg-gray-800 rounded-lg text-blue-500"><i class="fa-solid fa-bars"></i></button>
                <div>
                    <h1 class="font-bold text-gray-100 uppercase text-sm leading-none">VDC LIVE LOG</h1>
                    <span class="text-[8px] text-blue-600 font-black tracking-widest italic uppercase">Sync v24.10 - Detailed Heartbeat</span>
                </div>
            </div>
            <button id="powerBtn" onclick="handlePowerToggle()" class="w-12 h-12 flex items-center justify-center rounded-full border-4 shadow-xl transition-all"></button>
        </nav>

        <div class="flex-1 overflow-hidden relative">
            <div id="page-stats" class="page-content active p-4 space-y-4 overflow-y-auto">
                <div class="grid grid-cols-2 gap-3 text-center">
                    <div class="bg-blue-900/10 border border-blue-500/20 rounded-2xl p-6 font-bold"><div class="text-4xl text-blue-400" id="queueCount">0</div><div class="text-[9px] text-gray-500 mt-2 uppercase italic">Hàng đợi thô</div></div>
                    <div class="bg-emerald-900/10 border border-emerald-500/20 rounded-2xl p-6 font-bold"><div class="text-4xl text-emerald-400" id="leadCountStat">0</div><div class="text-[9px] text-gray-500 mt-2 uppercase italic">Data hoàn thiện</div></div>
                </div>
                <div class="bg-gray-950 border border-gray-800 rounded-2xl p-4 min-h-[300px] overflow-hidden">
                    <div class="text-[10px] text-gray-600 uppercase font-black mb-3 flex items-center gap-2"><i class="fa-solid fa-terminal"></i> Nhật ký tác chiến chi tiết</div>
                    <div id="log-container" class="space-y-2 h-[250px] overflow-y-auto font-mono text-[11px] leading-relaxed">
                        <div id="botStatusText" class="text-blue-400">Đang khởi động hệ thống...</div>
                    </div>
                </div>
            </div>

            <div id="page-leads" class="page-content">
                <div class="flex-1 overflow-auto bg-gray-950">
                    <table class="w-full text-left">
                        <thead class="bg-gray-900 sticky top-0 border-b border-gray-800 z-10">
                            <tr class="text-[9px] text-gray-500 uppercase font-bold"><th class="p-4">Doanh nghiệp</th><th class="p-4 text-center">Nhân sự</th><th class="p-4 text-center">Liên hệ</th><th class="p-4 w-10"></th></tr>
                        </thead>
                        <tbody id="leadTableBody" class="divide-y divide-gray-900"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { apiKey: "AIzaSyCCF9A0dKF5Rwp0v5RoSVDxjdWJawUxVFU", authDomain: "vdc-crm-southern.firebaseapp.com", databaseURL: "https://vdc-crm-southern-default-rtdb.firebaseio.com", projectId: "vdc-crm-southern", storageBucket: "vdc-crm-southern.firebasestorage.app", messagingSenderId: "793485969742", appId: "1:793485969742:web:40bd247e271eca62df361f" };
        const app = initializeApp(firebaseConfig); const db = getDatabase(app);
        
        let currentStatus = 'PAUSED', rawLeadsData = {};

        const provinces = ["An Giang", "Bà Rịa - Vũng Tàu", "Bắc Giang", "Bắc Kạn", "Bạc Liêu", "Bắc Ninh", "Bến Tre", "Bình Định", "Bình Dương", "Bình Phước", "Bình Thuận", "Cà Mau", "Cần Thơ", "Cao Bằng", "Đà Nẵng", "Đắk Lắk", "Đắk Nông", "Điện Biên", "Đồng Nai", "Đồng Tháp", "Gia Lai", "Hà Giang", "Hà Nam", "Hà Nội", "Hà Tĩnh", "Hải Dương", "Hải Phòng", "Hậu Giang", "Hòa Bình", "Hưng Yên", "Khánh Hòa", "Kiên Giang", "Kon Tum", "Lai Châu", "Lâm Đồng", "Lạng Sơn", "Lào Cai", "Long An", "Nam Định", "Nghệ An", "Ninh Bình", "Ninh Thuận", "Phú Thọ", "Phú Yên", "Quảng Bình", "Quảng Nam", "Quảng Ngãi", "Quảng Ninh", "Quảng Trị", "Sóc Trăng", "Sơn La", "Tây Ninh", "Thái Bình", "Thái Nguyên", "Thanh Hóa", "Thừa Thiên Huế", "Tiền Giang", "TP. Hồ Chí Minh", "Trà Vinh", "Tuyên Quang", "Vĩnh Long", "Vĩnh Phúc", "Yên Bái"];
        const selectLoc = document.getElementById('target_loc');
        provinces.forEach(p => { const opt = document.createElement('option'); opt.value = p; opt.innerText = p; selectLoc.appendChild(opt); });

        window.toggleSidebar = () => { document.getElementById('sidebar').classList.toggle('sidebar-closed'); document.getElementById('sidebarOverlay').classList.toggle('hidden'); };
        window.switchPage = (p) => { document.querySelectorAll('.page-content').forEach(el => el.classList.remove('active')); document.getElementById('page-'+p).classList.add('active'); toggleSidebar(); };
        window.handlePowerToggle = () => set(ref(db, 'config_system/status'), currentStatus === 'RUNNING' ? 'PAUSED' : 'RUNNING');

        onValue(ref(db, 'hr_status/bot_VDC_CORE'), s => { 
            const d = s.val(); if(d) {
                const log = document.getElementById('botStatusText');
                log.innerHTML = `<span class="text-gray-600">[${d.last_active}]</span> <span class="text-blue-300">${d.message}</span><br>` + log.innerHTML;
            }
        });
        onValue(ref(db, 'hr_leads'), s => { rawLeadsData = s.val() || {}; document.getElementById('leadCountStat').innerText = Object.keys(rawLeadsData).length; renderLeads(); });
        onValue(ref(db, 'hr_queue'), s => { document.getElementById('queueCount').innerText = Object.keys(s.val()||{}).length; });
        onValue(ref(db, 'config_system/status'), s => { 
            currentStatus = s.val() || 'PAUSED'; 
            const b = document.getElementById('powerBtn');
            b.className = currentStatus === 'RUNNING' ? "w-12 h-12 flex items-center justify-center rounded-full border-4 border-emerald-500 bg-emerald-600 text-white shadow-lg" : "w-12 h-12 flex items-center justify-center rounded-full border-4 border-red-500 bg-red-600 text-white";
            b.innerHTML = '<i class="fa-solid fa-power-off text-xl"></i>';
        });

        function renderLeads() {
            const tbody = document.getElementById('leadTableBody'); tbody.innerHTML = '';
            Object.entries(rawLeadsData).sort((a,b) => (b[1].timestamp || 0) - (a[1].timestamp || 0)).forEach(([k,v]) => {
                const phone = v.phone?.split(' - ')[0].replace(/[^0-9]/g, '') || '';
                const row = document.createElement('tr');
                row.className = "border-b border-gray-900 hover:bg-gray-900/50";
                row.innerHTML = `
                    <td class="p-4 company-name-cell">
                        <div class="font-bold text-gray-200 text-xs uppercase">${v.company || v.name}</div>
                        <div class="flex gap-2 mt-1">
                            <span class="text-[8px] px-1.5 py-0.5 rounded ${v.status_code === 'Đang hoạt động' ? 'bg-emerald-900/30 text-emerald-500' : 'bg-red-900/30 text-red-500'} font-bold uppercase">${v.status_code || 'N/A'}</span>
                        </div>
                    </td>
                    <td class="p-4 text-center text-[10px] text-yellow-500 font-bold">${v.labor_size || '---'}</td>
                    <td class="p-4 text-center">
                        <div class="flex justify-center gap-4 text-lg">
                            ${phone ? `<a href="tel:${phone}" class="text-emerald-400"><i class="fa-solid fa-phone"></i></a>` : ''}
                            ${v.email && v.email !== 'Chưa có' ? `<a href="mailto:${v.email}" class="text-purple-400"><i class="fa-solid fa-envelope"></i></a>` : ''}
                        </div>
                    </td>
                    <td class="p-4 text-center"><button onclick="remove(ref(db,'hr_leads/${k}'))" class="text-gray-800 hover:text-red-500"><i class="fa-solid fa-trash"></i></button></td>
                `;
                tbody.appendChild(row);
            });
        }
    </script>
</body>
</html>
